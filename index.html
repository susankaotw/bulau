<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ä¸è€å¹³è¡¡éª¨æ¶ä¸­å¿ƒï½œAI åŠ©ç† DEMO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui,-apple-system,"Noto Sans TC","Segoe UI",Arial; max-width: 720px; margin: 24px auto; padding: 0 16px; background:#fafafa; }
    h1 { margin:0 0 8px; }
    label { display:block; margin: 12px 0 6px; font-weight:600; }
    input, textarea, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; background:#fff; }
    button { margin-top:14px; padding:10px 16px; border:1px solid var(--border); background:#fff; border-radius:12px; cursor:pointer; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .chip { padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px; cursor:pointer }
    #result { margin-top:14px; }
    .card { border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff }
    .muted { color:var(--muted); font-size:12px }
    details { margin-top:12px }
    summary { cursor:pointer; color:#2563eb }
  </style>
</head>
<body>
  <h1>ä¸è€åŠ©ç†ï¼ˆæŸ¥è©¢ DEMOï¼‰</h1>
  <div class="muted">ç›®å‰åƒ…æä¾›ã€ŒæŸ¥è©¢ã€åŠŸèƒ½ï¼›å…§å®¹å³æ™‚è®€å– Notion çŸ¥è­˜åº«ã€‚</div>

  <label>Email</label>
  <input id="email" value="test@user.com"/>

  <label>å•é¡Œ</label>
  <textarea id="q" rows="3" placeholder="ä¾‹å¦‚ï¼šè‚©é ¸ç— ç—›ã€æ‰‹èˆ‰ä¸èµ·ä¾†"></textarea>
  <div class="chips">
    <span class="chip" data-q="è‚©é ¸ç— ç—›">è‚©é ¸ç— ç—›</span>
    <span class="chip" data-q="æ‰‹èˆ‰ä¸èµ·ä¾†">æ‰‹èˆ‰ä¸èµ·ä¾†</span>
  </div>

  <button id="send">é€å‡ºæŸ¥è©¢</button>
  <div id="result" style="display:none"></div>

  <script>
    // å°å·¥å…·ï¼šè·³è„« HTML
    function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

    // ä¾ API å›æ‡‰æ¸²æŸ“çµæœ
    function renderResult(data){
      const box = document.getElementById('result');
      box.style.display = 'block';

      // éŒ¯èª¤æˆ–æ‰¾ä¸åˆ°ï¼ˆæˆ–å¾Œç«¯å›æ–‡å­—æç¤ºï¼‰
      if (!data || data.error || typeof data.answer === 'string') {
        const msg = data?.error || data?.answer || 'æŸ¥ä¸åˆ°ç›¸ç¬¦æ¢ç›®ï¼Œè«‹æ›å€‹å•æ³•ï¼ˆä¾‹ï¼šè‚©é ¸ç— ç—›ã€æ‰‹èˆ‰ä¸èµ·ä¾†ï¼‰ã€‚';
        box.innerHTML = `
          <div class="card" style="border-color:#fecaca;background:#fff1f2">
            <b style="color:#b91c1c">æç¤º</b><br>
            <div style="margin-top:8px;white-space:pre-wrap">${esc(msg)}</div>
          </div>`;
        return;
      }

      // æŸ¥è©¢çµæœï¼ˆanswer æ˜¯ç‰©ä»¶ï¼›éµåå·²ç”±å¾Œç«¯æ˜ å°„åˆ°èˆŠç‰ˆï¼‰
      const a = data.answer || {};
      const ver  = data.version ? `ç‰ˆæœ¬ï¼š${esc(data.version)}` : '';
      const time = data.updated_at ? `æ›´æ–°ï¼š${new Date(data.updated_at).toLocaleString()}` : '';
      const matched = data.matched ? `ï¼ˆåŒ¹é…ï¼š${esc(data.matched)}ï¼‰` : '';

      const rows = [];
      if (a['è¡›æ•™ç‰ˆå›è¦†']) rows.push(`
        <div style="margin-top:12px;line-height:1.7">
          <b>è¡›æ•™é‡é»</b>ï¼ˆæ•™æç‰ˆå›è¦†ï¼‰<br>${esc(a['è¡›æ•™ç‰ˆå›è¦†'])}
        </div>`);
      if (a['å»ºè­°å‹•ä½œ']) rows.push(`
        <div style="margin-top:12px;line-height:1.7">
          <b>å»ºè­°å‹•ä½œ / åˆ†ç¯€</b>ï¼ˆå°æ‡‰è„Šæ¤åˆ†ç¯€ï¼‰<br>${esc(a['å»ºè­°å‹•ä½œ'])}
        </div>`);
      if (a['ç¦å¿Œèˆ‡æ³¨æ„']) rows.push(`
        <div style="margin-top:12px;line-height:1.7;background:#fff7ed;border:1px solid #fdba74;border-radius:10px;padding:10px">
          <b>ç¦å¿Œèˆ‡æ³¨æ„</b>ï¼ˆç¶“çµ¡èˆ‡è£œå……ï¼‰<br>${esc(a['ç¦å¿Œèˆ‡æ³¨æ„'])}
        </div>`);

      const pro = a['å°ˆæ¥­ç‰ˆå›è¦†'] ? `
        <details>
          <summary>é¡¯ç¤ºå°ˆæ¥­ç‰ˆï¼ˆè‡¨åºŠæµç¨‹å»ºè­°ï¼‰</summary>
          <div style="margin-top:8px;white-space:pre-wrap;line-height:1.7">${esc(a['å°ˆæ¥­ç‰ˆå›è¦†'])}</div>
        </details>` : '';

      // ä¸€éµè¤‡è£½ï¼šè¡›æ•™ + å»ºè­°å‹•ä½œ
      const toCopy = (a['è¡›æ•™ç‰ˆå›è¦†']||'') + (a['å»ºè­°å‹•ä½œ']?('\nå»ºè­°ï¼š'+a['å»ºè­°å‹•ä½œ']):'');
      const copyBtn = `
        <button onclick="navigator.clipboard.writeText(${JSON.stringify(toCopy)}); this.textContent='å·²è¤‡è£½'; setTimeout(()=>this.textContent='è¤‡è£½è¡›æ•™',1200);">
          è¤‡è£½è¡›æ•™
        </button>`;

      box.innerHTML = `
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div style="font-size:18px;font-weight:700">ğŸ§¾ ${esc(a['å•é¡Œ']||'å›è¦†')}</div>
              <div class="muted">ä¸»é¡Œï¼š${esc(a['ä¸»é¡Œ']||'-')} ${matched}</div>
            </div>
            ${copyBtn}
          </div>

          ${rows.join('') || '<div style="margin-top:12px;color:#6b7280">ï¼ˆæ­¤æ¢ç›®å°šç„¡å…§å®¹ï¼‰</div>'}
          ${pro}

          <div class="muted" style="margin-top:12px">${ver}ã€€${time}</div>
        </div>`;
    }

    // é€å‡ºæŸ¥è©¢
    async function doQuery(){
      const body = {
        email: document.getElementById('email').value,
        question: document.getElementById('q').value,
        mode: 'æŸ¥è©¢'
      };
      const box = document.getElementById('result');
      box.style.display = 'block';
      box.innerHTML = '<div class="muted">æŸ¥è©¢ä¸­â€¦</div>';
      try {
        const resp = await fetch('/api/answer', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        renderResult(data);
      } catch (e) {
        renderResult({ error: String(e) });
      }
    }

    document.getElementById('send').onclick = doQuery;
    document.querySelectorAll('.chip').forEach(el=>{
      el.onclick = ()=>{ document.getElementById('q').value = el.dataset.q; doQuery(); };
    });
    document.getElementById('q').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) doQuery();
    });
  </script>
</body>
</html>
