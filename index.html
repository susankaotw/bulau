<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ä¸è€åŠ©ç†ï¼ˆæŸ¥è©¢ç‰ˆ DEMOï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "PingFang TC", "Noto Sans TC", sans-serif; max-width: 720px; margin: 24px auto; padding: 0 16px; }
    label { display:block; margin: 12px 0 6px; font-weight:600; }
    input, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; }
    button { margin-top:14px; padding:10px 16px; border:0; border-radius:10px; cursor:pointer; background:#111827; color:#fff; }
    .muted { color:#6b7280; font-size:12px; }
    .card { border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:#fff; margin-top:12px; }
  </style>
</head>
<body>
  <h1>ä¸è€åŠ©ç†ï¼ˆæŸ¥è©¢ç‰ˆ DEMOï¼‰</h1>
  <div class="muted">ç›®å‰åƒ…æ”¯æ´ã€ŒæŸ¥è©¢ã€ï¼›å…§å®¹å³æ™‚ä¾†è‡ª Notion çŸ¥è­˜åº«ã€‚</div>

  <label>Email</label>
  <input id="email" value="test@user.com" autocomplete="email"/>

  <label>å•é¡Œ</label>
  <textarea id="q" rows="3" placeholder="ä¾‹ï¼šè‚©é ¸ç— ç—›ã€æ‰‹èˆ‰ä¸èµ·ä¾†">è‚©é ¸ç— ç—›</textarea>

  <button id="send">é€å‡ºæŸ¥è©¢</button>
  <div id="result" style="display:none;margin-top:12px"></div>

  <p class="muted" style="margin-top:18px">
    æœ¬ç³»çµ±æä¾›ä¸€èˆ¬è¡›æ•™è³‡è¨Šï¼Œ<b>ä¸å–ä»£é†«ç™‚è¨ºç™‚</b>ï¼›è‹¥æœ‰å¤–å‚·åŠ‡ç—›ã€æ‰‹éº»ç„¡åŠ›ã€ç™¼ç‡’ç­‰ç´…æ——ç—‡ç‹€ï¼Œè«‹å…ˆå°±é†«è©•ä¼°ã€‚
  </p>

  <script>
    const esc = (s)=> (s ?? "").toString().replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    function cardHTML(a){
      const ver  = a.version ? `ç‰ˆæœ¬ï¼š${esc(a.version)}` : '';
      const time = a.updated_at ? `æ›´æ–°ï¼š${new Date(a.updated_at).toLocaleString()}` : '';
      const blocks = [];
      if (a['æ•™æç‰ˆå›è¦†']) blocks.push(`
        <div style="margin-top:12px;line-height:1.7">
          <b>æ•™æç‰ˆå›è¦†</b><br>${esc(a['æ•™æç‰ˆå›è¦†'])}
        </div>`);
      if (a['å°æ‡‰è„Šæ¤åˆ†ç¯€']) blocks.push(`
        <div style="margin-top:12px;line-height:1.7">
          <b>å°æ‡‰è„Šæ¤åˆ†ç¯€</b><br>${esc(a['å°æ‡‰è„Šæ¤åˆ†ç¯€'])}
        </div>`);
      if (a['ç¶“çµ¡èˆ‡è£œå……']) blocks.push(`
        <div style="margin-top:12px;line-height:1.7;background:#fff7ed;border:1px solid #fdba74;border-radius:10px;padding:10px">
          <b>ç¶“çµ¡èˆ‡è£œå……</b><br>${esc(a['ç¶“çµ¡èˆ‡è£œå……'])}
        </div>`);
      const pro = a['è‡¨åºŠæµç¨‹å»ºè­°'] ? `
        <details style="margin-top:12px">
          <summary style="cursor:pointer;color:#2563eb">è‡¨åºŠæµç¨‹å»ºè­°ï¼ˆå°ˆæ¥­ç‰ˆï¼‰</summary>
          <div style="margin-top:8px;white-space:pre-wrap;line-height:1.7">${esc(a['è‡¨åºŠæµç¨‹å»ºè­°'])}</div>
        </details>` : '';
      return `
        <div class="card">
          <div style="font-size:18px;font-weight:700">ğŸ§¾ ${esc(a['å•é¡Œ']||'å›è¦†')}</div>
          <div class="muted">ä¸»é¡Œï¼š${esc(a['ä¸»é¡Œ']||'-')}</div>
          ${blocks.join('') || '<div style="margin-top:12px;color:#6b7280">ï¼ˆæ­¤æ¢ç›®å°šç„¡å…§å®¹ï¼‰</div>'}
          ${pro}
          <div class="muted" style="margin-top:12px">${ver}ã€€${time}</div>
        </div>`;
    }

    function renderResult(data){
      const box = document.getElementById('result');
      box.style.display = 'block';

      // éŒ¯èª¤æˆ–æŸ¥ç„¡è³‡æ–™ï¼ˆæˆ–å¾Œç«¯å›å­—ä¸²æç¤ºï¼‰
      if (!data || data.error || typeof data.answer === 'string') {
        const msg = data?.error || data?.answer || 'æŸ¥ä¸åˆ°ç›¸ç¬¦æ¢ç›®ï¼Œè«‹æ›å€‹é—œéµå­—ï¼ˆä¾‹ï¼šè‚©é ¸ç— ç—›ï¼‰ã€‚';
        box.innerHTML = `
          <div style="border:1px solid #fecaca;background:#fff1f2;border-radius:12px;padding:14px">
            <b style="color:#b91c1c">æç¤º</b><br>
            <div style="margin-top:8px;white-space:pre-wrap">${esc(msg)}</div>
          </div>`;
        return;
      }

      // æœ‰å¤šç­† items å°±é€ä¸€é¡¯ç¤ºï¼›å¦å‰‡é¡¯ç¤ºå–®ç­† answerï¼ˆç›¸å®¹èˆŠç‰ˆï¼‰
      const items = Array.isArray(data.items) && data.items.length ? data.items : null;
      if (items) {
        const header = `<div class="muted">æ‰¾åˆ° ${items.length} ç­†çµæœï¼ˆåŒ¹é…ï¼š${esc(data.matched || '')}ï¼‰</div>`;
        box.innerHTML = header + items.map(cardHTML).join("");
      } else {
        box.innerHTML = cardHTML(data.answer || {});
      }
    }

    document.getElementById('send').onclick = async () => {
      const body = {
        email: document.getElementById('email').value,
        question: document.getElementById('q').value,
        mode: 'æŸ¥è©¢'
      };
      const box = document.getElementById('result');
      box.style.display = 'block';
      box.innerHTML = '<div style="padding:8px;color:#6b7280">æŸ¥è©¢ä¸­â€¦</div>';
      try {
        const resp = await fetch('/api/answer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        renderResult(data);
      } catch (e) {
        renderResult({ error: String(e) });
      }
    };
  </script>
</body>
</html>
